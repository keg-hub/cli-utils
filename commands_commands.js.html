<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>commands/commands.js - CLI Utils</title>
    
    <meta name="description" content="Utility methods for building Node.js CLI's" />
    
        <meta name="keywords" content="utils, cli, task, tasks" />
        <meta name="keyword" content="utils, cli, task, tasks" />
    
    
    
    <meta property="og:title" content="CLIJS Utils"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    <meta property="og:site_name" content="cli-utils"/>
    <meta property="og:url" content="https://github.com/keg-hub/keg-cli/tree/develop/repos/cli-utils"/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/keg-hub/keg-cli/tree/develop/repos/cli-utils" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-Tasks.html">Tasks</a></li></ul><h3>Modules</h3><ul><li><a href="module-CLI.html">CLI</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-CLI.html#~runTask">runTask</a></li><li data-type='method' style='display: none;'><a href="module-CLI.html#~setAppRoot">setAppRoot</a></li><li data-type='method' style='display: none;'><a href="module-CLI.html#~showHelp">showHelp</a></li></ul></li><li></li><li></li><li><a href="module-Commands.html">Commands</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Commands.html#.docker">docker</a></li><li data-type='method' style='display: none;'><a href="module-Commands.html#.dockerCompose">dockerCompose</a></li><li data-type='method' style='display: none;'><a href="module-Commands.html#.node">node</a></li><li data-type='method' style='display: none;'><a href="module-Commands.html#.npm">npm</a></li><li data-type='method' style='display: none;'><a href="module-Commands.html#.npx">npx</a></li><li data-type='method' style='display: none;'><a href="module-Commands.html#.yarn">yarn</a></li><li data-type='method' style='display: none;'><a href="module-Commands.html#~containerExec">containerExec</a></li><li data-type='method' style='display: none;'><a href="module-Commands.html#~dockerCmd">dockerCmd</a></li><li data-type='method' style='display: none;'><a href="module-Commands.html#~dockerExec">dockerExec</a></li><li data-type='method' style='display: none;'><a href="module-Commands.html#~inDocker">inDocker</a></li></ul></li><li></li><li><a href="module-Constants.html">Constants</a></li><li><a href="module-Error.html">Error</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Error.html#~throwErr">throwErr</a></li><li data-type='method' style='display: none;'><a href="module-Error.html#~throwExitError">throwExitError</a></li><li data-type='method' style='display: none;'><a href="module-Error.html#~throwNoTask">throwNoTask</a></li></ul></li><li></li><li><a href="module-FS.html">FS</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-FS.html#~buildFoundArray">buildFoundArray</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~copyFile">copyFile</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~copyFileSync">copyFileSync</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~copyStream">copyStream</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~copySync">copySync</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~emptyDirSync">emptyDirSync</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~ensureDirSync">ensureDirSync</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~getFiles">getFiles</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~getFilesSync">getFilesSync</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~getFolderContent">getFolderContent</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~getFolderContentSync">getFolderContentSync</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~getFolders">getFolders</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~getFoldersSync">getFoldersSync</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~getPackageRoot">getPackageRoot</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~limboify">limboify</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~mkDir">mkDir</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~movePath">movePath</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~pathExists">pathExists</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~pathExistsSync">pathExistsSync</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~readDir">readDir</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~readFile">readFile</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~readFileSync">readFileSync</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~removeFile">removeFile</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~removeFileSync">removeFileSync</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~requireFile">requireFile</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~stat">stat</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~writeFile">writeFile</a></li><li data-type='method' style='display: none;'><a href="module-FS.html#~writeFileSync">writeFileSync</a></li></ul></li><li></li><li><a href="module-Global-Config.html">Global-Config</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Global-Config.html#~addGlobalOptions">addGlobalOptions</a></li><li data-type='method' style='display: none;'><a href="module-Global-Config.html#~getDefaultEnv">getDefaultEnv</a></li><li data-type='method' style='display: none;'><a href="module-Global-Config.html#~getEditorCmd">getEditorCmd</a></li><li data-type='method' style='display: none;'><a href="module-Global-Config.html#~getGlobalOptions">getGlobalOptions</a></li><li data-type='method' style='display: none;'><a href="module-Global-Config.html#~getKegGlobalConfig">getKegGlobalConfig</a></li><li data-type='method' style='display: none;'><a href="module-Global-Config.html#~getKegSetting">getKegSetting</a></li><li data-type='method' style='display: none;'><a href="module-Global-Config.html#~getPathFromConfig">getPathFromConfig</a></li></ul></li><li></li><li></li><li><a href="module-Helpers.html">Helpers</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Helpers.html#~addFlag">addFlag</a></li><li data-type='method' style='display: none;'><a href="module-Helpers.html#~addParam">addParam</a></li><li data-type='method' style='display: none;'><a href="module-Helpers.html#~addToProcess">addToProcess</a></li><li data-type='method' style='display: none;'><a href="module-Helpers.html#~addValues">addValues</a></li></ul></li><li><a href="module-Network.html">Network</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Network.html#~getAddresses">getAddresses</a></li><li data-type='method' style='display: none;'><a href="module-Network.html#~getHostIP">getHostIP</a></li><li data-type='method' style='display: none;'><a href="module-Network.html#~getPrivateIPs">getPrivateIPs</a></li><li data-type='method' style='display: none;'><a href="module-Network.html#~getPublicIP">getPublicIP</a></li><li data-type='method' style='display: none;'><a href="module-Network.html#~getPublicIPsForUrl">getPublicIPsForUrl</a></li><li data-type='method' style='display: none;'><a href="module-Network.html#~ipIsInRange">ipIsInRange</a></li><li data-type='method' style='display: none;'><a href="module-Network.html#~isPrivateIP">isPrivateIP</a></li></ul></li><li></li><li></li><li></li><li></li><li></li><li></li><li><a href="module-Process.html">Process</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Process.html#~addToProcess">addToProcess</a></li><li data-type='method' style='display: none;'><a href="module-Process.html#~getEventExitCode">getEventExitCode</a></li><li data-type='method' style='display: none;'><a href="module-Process.html#~onProcessExit">onProcessExit</a></li></ul></li><li></li><li><a href="module-Tap.html">Tap</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Tap.html#~getTapConfig">getTapConfig</a></li><li data-type='method' style='display: none;'><a href="module-Tap.html#~getTapPackage">getTapPackage</a></li><li data-type='method' style='display: none;'><a href="module-Tap.html#~getTapPath">getTapPath</a></li><li data-type='method' style='display: none;'><a href="module-Tap.html#~getTapRoot">getTapRoot</a></li></ul></li><li></li><li></li><li><a href="module-Task.html">Task</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Task.html#~buildTaskData">buildTaskData</a></li><li data-type='method' style='display: none;'><a href="module-Task.html#~executeTask">executeTask</a></li><li data-type='method' style='display: none;'><a href="module-Task.html#~findTask">findTask</a></li><li data-type='method' style='display: none;'><a href="module-Task.html#~getTaskDefinitions">getTaskDefinitions</a></li><li data-type='method' style='display: none;'><a href="module-Task.html#~hasHelpArg">hasHelpArg</a></li><li data-type='method' style='display: none;'><a href="module-Task.html#~parseTaskArgs">parseTaskArgs</a></li><li data-type='method' style='display: none;'><a href="module-Task.html#~registerTasks">registerTasks</a></li><li data-type='method' style='display: none;'><a href="module-Task.html#~runInternalTask">runInternalTask</a></li><li data-type='method' style='display: none;'><a href="module-Task.html#~setSharedOptions">setSharedOptions</a></li><li data-type='method' style='display: none;'><a href="module-Task.html#~setTaskFolder">setTaskFolder</a></li><li data-type='method' style='display: none;'><a href="module-Task.html#~sharedOptions">sharedOptions</a></li><li data-type='method' style='display: none;'><a href="module-Task.html#~validateTask">validateTask</a></li></ul></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul><h3>Classes</h3><ul><li><a href="Log.html">Log</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Log.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="Log.html#color">color</a></li><li data-type='method' style='display: none;'><a href="Log.html#empty">empty</a></li><li data-type='method' style='display: none;'><a href="Log.html#header">header</a></li><li data-type='method' style='display: none;'><a href="Log.html#highlight">highlight</a></li><li data-type='method' style='display: none;'><a href="Log.html#label">label</a></li><li data-type='method' style='display: none;'><a href="Log.html#pair">pair</a></li><li data-type='method' style='display: none;'><a href="Log.html#print">print</a></li><li data-type='method' style='display: none;'><a href="Log.html#removeTag">removeTag</a></li><li data-type='method' style='display: none;'><a href="Log.html#setColors">setColors</a></li><li data-type='method' style='display: none;'><a href="Log.html#setTag">setTag</a></li><li data-type='method' style='display: none;'><a href="Log.html#spacedMsg">spacedMsg</a></li><li data-type='method' style='display: none;'><a href="Log.html#spaceMsg">spaceMsg</a></li><li data-type='method' style='display: none;'><a href="Log.html#stderr">stderr</a></li><li data-type='method' style='display: none;'><a href="Log.html#stdout">stdout</a></li><li data-type='method' style='display: none;'><a href="Log.html#subHeader">subHeader</a></li><li data-type='method' style='display: none;'><a href="Log.html#table">table</a></li><li data-type='method' style='display: none;'><a href="Log.html#toggleTag">toggleTag</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">commands/commands.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** @module Commands */

const { inDocker } = require('./inDocker')
const { getAppRoot } = require('../appRoot')
const { Logger } = require('../logger/logger')
const { isArr, noOpObj, noPropArr, camelCase, isStr, exists } = require('@keg-hub/jsutils')
const { spawnCmd, asyncCmd:execCmd } = require('@keg-hub/spawn-cmd')

/**
 * Ensures the passed in data is an array
 * If data is not an array, it must has a split method to convert to an array
 * @function
 * @private
 * @param {string|Array} [data=[]] - Data to ensure is an array
 *
 * @returns {Array} - Data converted to an array
 */
const ensureArray = (data=noPropArr) => (
  !exists(data)
    ? noPropArr
    : isArr(data)
      ? data
      : isStr(data)
        ? data.split(' ')
        : Logger.error(
            `The runCmd method requires arguments be an Array or string.\n`,
            `Instead got ${typeof data}: ${data}\n`,
            `Args will be ignored!\n`,
          ) || noPropArr
)


/**
 * Normalize the env(s) options by checking for both env &amp;&amp; envs
 * Then merges them together
 * @function
 * @private
 * @param {Object} options - Options forwarded to the child process
 * 
 * @return {Object} - Merged env from options object
 */
const normalizeEnv = options => {
  const { envs=noOpObj, env=noOpObj } = options
  return {...envs, ...env}
}

/**
 * Runs a child process using spawnCmd
 * Passes along the current process.env object
 * @function
 * @private
 * @param {string} cmd - Command to run in the child process
 * @param {Array} args - Arguments to pass to the cmd within the child process
 * @param {Object} options - Options forwarded to the child process
 * @param {string} cwd - Directory where the child process should be run from
 * @param {boolean} asExec - Run command with execCmd instead of spawnCmd
 *
 * @returns {Object|undefined} - Object if exec is true, undefined if false
 */
const runCmd = async (cmd, args=noPropArr, options=noOpObj, cwd, asExec) => {
  const {
    exec,
    onStdOut,
    onStdErr,
    onError,
    onExit,
    env,
    envs,
    ...opts
  } = options

  const cmdOpts = {
    ...opts,
    // Normalize the env(s) options
    env: {...process.env, ...normalizeEnv(options)}
  }
  
  return (exec || asExec)
    ? await execCmd(
        `${cmd} ${ensureArray(args).join(' ')}`,
        cmdOpts,
        cwd || getAppRoot()
      )
    : await spawnCmd(cmd, {
        onStdOut,
        onStdErr,
        onError,
        onExit,
        args: ensureArray(args),
        options: cmdOpts,
        cwd: cwd || getAppRoot(),
      })
}

/**
 * Generates helper methods for calling common executables within a child process
 * @Object
 * @private
 */
const shortcutCmds = Array.from([
  'npm',
  'npx',
  'node',
  'yarn',
  'docker',
  'docker-compose',
])
.reduce((cmds, cmd) => {
  /**
   * Creates a helper to call the executable within a child process
   * @private
   * @param {Array|string} args - Arguments to pass to the npm command
   */
  cmds[camelCase(cmd)] = (args, ...opts) => runCmd(cmd, args, ...opts)

  return cmds
}, {})


/**
 * Converts the passed in envs Object into an array of docker argument envs
 * @function
 * @private
 * @param {Object} envs - Key value pair of envs
 *
 * @returns {Array} - Formatted array of envs matching docker cli requirements
 */
const envToStr = envs => Object.keys(envs)
  .reduce((acc, key) => {
    acc.push(`--env`)
    acc.push(`${key}=${envs[key]}`)

    return acc
  }, [])

/**
 * Helper to call the docker exec command directly
 * @function
 * @param {String} containerName - name of container to run command within
 * @param {Array&lt;string>} args - docker exec args
 * @param  {*} opts - docker exec opts
 * @example
 * dockerExec('&lt;container-name>', 'yarn install')
 */
const dockerExec = (containerName, args, opts=noOpObj, ...extra) => {
  const cmdEnvs = normalizeEnv(opts)
  const cmdArgs = [
    'exec',
    '-it',
    ...envToStr(cmdEnvs),
    containerName,
    ...ensureArray(args)
  ]

  return runCmd('docker', cmdArgs, {...opts, env: cmdEnvs}, ...extra)
}

/**
 * Runs a command inside the docker container
 * @function
 * @param {string} containerName - name of container to run command within ( **Ignored** )
 * @param {string|Array&lt;string>} args - docker exec args
 * @param  {Object} opts - docker exec opts
 * @param  {Object} opts.envs - docker exec envs
 * @param  {Object} opts.env - docker exec envs
 * @param  {Array&lt;string>} [extra] - Directory to run the command from
 * @example
 * dockerExec('container', 'npx playwright install firefox')
 */
const containerExec = (_, args, opts=noOpObj, ...extra) => {
  const argsArr = [...ensureArray(args)]
  const cmd = argsArr.shift()

  return runCmd(
    cmd,
    argsArr,
    {...opts, env: normalizeEnv(opts)},
    ...extra
  )
}

/**
 * Checks if inside a docker container.
 * If we are, then cont add call docker executable directly
 * Instead call the command directly inside the container
 * @function
 * @param {string} [containerName] - name of container to run command within ( **Ignored** )
 * @param {string|Array&lt;string>} args - docker exec args
 * @param  {Object} opts - docker exec opts
 * @param  {Object} opts.envs - docker exec envs
 * @param  {Object} opts.env - docker exec envs
 * @param  {Array&lt;string>} [extra] - Directory to run the command from
 *
 */
const dockerCmd = (...args) => inDocker() ? containerExec(...args) : dockerExec(...args)

module.exports = {
  execCmd,
  runCmd,
  spawnCmd,
  dockerCmd,
  dockerExec,
  /**
   * Creates a helper to call the **npx** executable within a child process
   * @function
   * @param {Array|string} args - Arguments to pass to the **npx** command
   * @param {Object} [options] - Options forwarded to the child process
   * @param {Object} options.env - Environment variables to set in the child process
   * @param {boolean} options.exec - Execute the command instead of calling child spawn process
   * @param {string} options.cwd - Directory to execute the command from
   * @example
   * await npx(`http-server ./public -p 3000 --cors`)
   * await npx([`http-server`, `./public`, `-p`, `3000`, `--cors`], { env: { MY_ENV: 'some-value' } })
   * @returns {Object|undefined} - Object if exec is true, undefined if false
   */
  npx: shortcutCmds.npx,
  /**
   * Creates a helper to call the **npm** executable within a child process
   * @function
   * @param {Array|string} args - Arguments to pass to the **npm** command
   * @param {Object} [options] - Options forwarded to the child process
   * @param {Object} options.env - Environment variables to set in the child process
   * @param {boolean} options.exec - Execute the command instead of calling child spawn process
   * @param {string} options.cwd - Directory to execute the command from
   * @example
   * await npm(`start`)
   * await npm([`start`], { env: { NODE_ENV: 'staging' } })
   * @returns {Object|undefined} - Object if exec is true, undefined if false
   */
  npm: shortcutCmds.npm,
  /**
   * Creates a helper to call the **node** executable within a child process
   * @function
   * @param {Array|string} args - Arguments to pass to the **node** command
   * @param {Object} [options] - Options forwarded to the child process
   * @param {Object} options.env - Environment variables to set in the child process
   * @param {boolean} options.exec - Execute the command instead of calling child spawn process
   * @param {string} options.cwd - Directory to execute the command from
   * @example
   * await node(`./index.js`)
   * await node([`./index.js`], { cwd: process.env.HOME, env: { KEY: 'VALUE' } })
   * @returns {Object|undefined} - Object if exec is true, undefined if false
   */
  node: shortcutCmds.node,
  /**
   * Creates a helper to call the **yarn** executable within a child process
   * @function
   * @param {Array|string} args - Arguments to pass to the **yarn** command
   * @param {Object} [options] - Options forwarded to the child process
   * @param {Object} options.env - Environment variables to set in the child process
   * @param {boolean} options.exec - Execute the command instead of calling child spawn process
   * @param {string} options.cwd - Directory to execute the command from
   * @example
   * await yarn(`start`)
   * await yarn([`start`])
   * @returns {Object|undefined} - Object if exec is true, undefined if false
   */
  yarn: shortcutCmds.yarn,
  /**
   * Creates a helper to call the **docker** executable within a child process
   * @function
   * @param {Array|string} args - Arguments to pass to the **docker** command
   * @param {Object} [options] - Options forwarded to the child process
   * @param {Object} options.env - Environment variables to set in the child process
   * @param {boolean} options.exec - Execute the command instead of calling child spawn process
   * @param {string} options.cwd - Directory to execute the command from
   * @example
   * await docker(`exec my-container /bin/bash`)
   * await docker([`exec`, `my-container`, `/bin/bash`], { env: {PORT: 1000}, exec: true })
   * @returns {Object|undefined} - Object if exec is true, undefined if false
   */
  docker: shortcutCmds.docker,
  /**
   * Creates a helper to call the **docker-compose** executable within a child process
   * @function
   * @param {Array|string} args - Arguments to pass to the **docker-compose** command
   * @param {Object} [options] - Options forwarded to the child process
   * @param {Object} options.env - Environment variables to set in the child process
   * @param {boolean} options.exec - Execute the command instead of calling child spawn process
   * @param {string} options.cwd - Directory to execute the command from
   * @example
   * await dockerCompose(`up`)
   * await dockerCompose([`up`, `-f`, `./path/to/docker-compose.yml`])
   * @returns {Object|undefined} - Object if exec is true, undefined if false
   */
  dockerCompose: shortcutCmds.dockerCompose,
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.10</a> on Wed Mar 29 2023 10:03:12 GMT-0700 (Mountain Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


    <link type="text/css" rel="stylesheet" href="styles/docs.css">
    
    <script src="scripts/docs.js"></script>
    
</body>
</html>
